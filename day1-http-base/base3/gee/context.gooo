package gee

import (
	"encoding/json"
	"fmt"
	"net/http"
)

// ä»£ç æœ€å¼€å¤´ï¼Œç»™map[string]interface{}èµ·ä¸€ä¸ªåˆ«ågee.Hï¼Œæ„å»ºJSONæ•°æ®æ—¶ï¼Œæ˜¾å¾—æ›´ç®€æ´
type H map[string]interface{}

type Context struct {
	// origin objects åŸå§‹å¯¹è±¡
	Writer http.ResponseWriter
	Req    *http.Request
	// request info è¯·æ±‚ä¿¡æ¯
	Path   string
	Method string
	// response info å“åº”ä¿¡æ¯
	StatusCode int
}

func newContext(w http.ResponseWriter, req *http.Request) *Context {
	return &Context{
		Writer: w,
		Req:    req,

		Path:   req.URL.Path,
		Method: req.Method,
	}
}

// è·å–POSTè¯·æ±‚ä¸­çš„è¡¨å•å‚æ•°
func (c *Context) PostForm(key string) string {
	return c.Req.FormValue(key)
}

// è·å–URLä¸­çš„æŸ¥è¯¢å‚æ•°
func (c *Context) Query(key string) string {
	return c.Req.URL.Query().Get(key)
}

// è®¾ç½®HTTPå“åº”ä¸­çš„çŠ¶æ€ç 
func (c *Context) Status(code int) {
	c.StatusCode = code
	c.Writer.WriteHeader(code)
}

// è®¾ç½®HTTPå“åº”å¤´
func (c *Context) SetHeader(key string, value string) {
	c.Writer.Header().Set(key, value)
}

// ç”Ÿæˆæ–‡æœ¬å“åº”ï¼Œè®¾ç½®"Content-Type"ä¸º"text/plain"ï¼Œç„¶åå†™å…¥æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²
func (c *Context) String(code int, format string, values ...interface{}) {
	c.SetHeader("Content-Type", "text/plain") // è¡¨ç¤ºå“åº”å†…å®¹æ˜¯çº¯æ–‡æœ¬
	c.Status(code)
	c.Writer.Write([]byte(fmt.Sprintf(format, values...))) // æ ¼å¼åŒ–å­—ç¬¦ä¸²å¹¶å†™å…¥å“åº”
}

// å°†ä¼ å…¥çš„å¯¹è±¡ç¼–ç ä¸º JSON æ ¼å¼ï¼Œå¹¶å‘é€ç»™å®¢æˆ·ç«¯ä½œä¸º HTTP å“åº”ã€‚
// ç”ŸæˆJSONå“åº”ï¼Œè®¾ç½®"Content-Type"ä¸º"application/json"
// ç„¶åä½¿ç”¨"json.Encoder"å°†å¯¹è±¡ç¼–ç ä¸ºJSONå†™å…¥å“åº”ã€‚å¦‚æœç¼–ç è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¿”å›500é”™è¯¯
func (c *Context) JSON(code int, obj interface{}) { // objä¸ºè¦ç¼–ç çš„å¯¹è±¡
	c.SetHeader("Content-Type", "application/json")
	c.Status(code)
	encoder := json.NewEncoder(c.Writer)
	if err := encoder.Encode(obj); err != nil {
		http.Error(c.Writer, err.Error(), 500)
	}
}

// ç”ŸæˆäºŒè¿›åˆ¶æ•°æ®å“åº”ï¼Œå†™å…¥åŸå§‹çš„å­—èŠ‚æ•°ç»„
func (c *Context) Data(code int, data []byte) {
	c.Status(code)
	c.Writer.Write(data)
}

// ç”ŸæˆHTMLå“åº”ï¼Œç”Ÿæˆ"Content-Type"ä¸º"text/html"ï¼Œç„¶åå†™å…¥HTMLå­—ç¬¦ä¸²
func (c *Context) HTML(code int, html string) {
	c.SetHeader("Content-Type", "text/html")
	c.Status(code)
	c.Writer.Write([]byte(html))
}
